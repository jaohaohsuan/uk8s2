---
- file: path={{ item }} state=directory
  with_items:
    - "{{ lookup('env','HOME') }}/.kube"
    - /etc/kubernetes/manifests
    - /etc/kubernetes/ssl

- template: >
    src=kubeconfig.j2
    dest=/var/lib/kubelet/kubeconfig
  notify:
    - restart kube-proxy
    - restart kubelet

- file: >
    src=/var/lib/kubelet/kubeconfig
    dest="{{ lookup('env','HOME') }}/.kube/config"
    state=link

- copy: >
    src="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/bin/kubernetes/server/bin/hyperkube"
    dest="/usr/local/bin/hyperkube"
    mode=0744
  notify:
    - restart kube-proxy
    - restart kubelet

- copy: src="{{ item }}.service" dest="/lib/systemd/system/{{ item }}.service"
  with_items:
    - kubelet
    - kube-proxy
  notify:
    - reload systemd
    - restart kube-proxy
    - restart kubelet

- template: src="{{ item }}.j2" dest="/etc/default/{{ item }}"
  with_items:
    - kubelet
    - kube-proxy
  notify:
    - reload systemd
    - restart kube-proxy
    - restart kubelet

- service: name={{ item }} state=started enabled=yes
  with_items:
    - kubelet
    - kube-proxy