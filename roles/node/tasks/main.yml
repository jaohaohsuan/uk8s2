---

- debug: msg="{{ lookup('env','HOME') }}"

- file: path="{{ item }}" state=directory
  with_items:
    - /etc/kubernetes/manifests
    - /etc/kubernetes/ssl

- file: path="{{ item }}" owner="{{ ansible_user }}" mode=0751 state=directory
  with_items:
    - "/var/lib/kubelet"

- file: path="{{ item }}" state=directory mode=0751 owner="{{ ansible_user }}"
  with_items:
    - "{{ lookup('env','HOME') }}/.kube"
  name: set user home directory permision

- template: >
    src=kubeconfig.j2
    dest=/var/lib/kubelet/kubeconfig
    mode=0640
    owner="{{ ansible_user }}"
  notify:
    - restart kube-proxy
    - restart kubelet

- file: >
    src=/var/lib/kubelet/kubeconfig
    dest="{{ lookup('env','HOME') }}/.kube/config"
    state=link
    owner="{{ ansible_user }}"

- copy: >
    src="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/bin/kubernetes/server/bin/hyperkube"
    dest="/usr/local/bin/hyperkube"
    mode=0744
  notify:
    - restart kube-proxy
    - restart kubelet
  tags:
    - "upgrade:{{ kubernetes_version }}"

- copy: src="{{ item }}.service" dest="/lib/systemd/system/{{ item }}.service"
  with_items:
    - kubelet
    - kube-proxy
  notify:
    - reload systemd
    - restart kube-proxy
    - restart kubelet

- template: src="{{ item }}.j2" dest="/etc/default/{{ item }}"
  with_items:
    - kubelet
    - kube-proxy
  notify:
    - reload systemd
    - restart kube-proxy
    - restart kubelet

- service: name={{ item }} state=started enabled=yes
  with_items:
    - kubelet
    - kube-proxy