---
- name: prepare k8s needs
  gather_facts: true
  hosts: localhost
  connection: local
  vars_prompt:
    - name: kubernetes_version
      prompt: kubernetes version
      default: "v1.3.4"
      private: no
    - name: kubernetes_checksum
      prompt: "DOWNLOAD SHA256 checksum"
      default: "818acc1a8ba61cff434d4c0c5aa3d342d06e6907b565cfd8651b8cfcf3f0a1e6"
      private: no
  vars:
    # master_ip: 192.168.80.117
    # master_hostname: master1
    downloads_dir: "{{ playbook_dir }}/downloads"
  tasks:
    - name: "mkdir -p {{ item }}"
      file: >
        path={{ downloads_dir }}/{{ item }}
        state=directory
      with_items:
        - "kubernetes-{{ kubernetes_version }}"
        - "kubernetes-{{ kubernetes_version }}/bin"

    - get_url: >
        url=https://github.com/kubernetes/kubernetes/releases/download/{{ kubernetes_version }}/kubernetes.tar.gz
        dest="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}.tar.gz"
        checksum=sha256:{{ kubernetes_checksum }}
      name: download k8s from github release tag {{ kubernetes_version }}

    - unarchive: >
        src="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}.tar.gz"
        dest="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/"
        creates={{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/kubernetes/version
        exclude="kubernetes/docs,kubernetes/server/kubernetes-server-linux-ppc64le.tar.gz,kubernetes/server/kubernetes-server-linux-arm64.tar.gz,kubernetes/server/kubernetes-server-linux-arm.tar.gz"
        copy=no
      name: "extract kubernetes-{{ kubernetes_version }}.tar.gz"

    - name: "extract Kubernetes binaries"
      unarchive: >
        src="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/kubernetes/server/kubernetes-server-linux-amd64.tar.gz"
        dest="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/bin/"
        creates={{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/bin/kubernetes/server/bin/hyperkube
        remote_src=no

    # - name: install kubectl
    #   file: >
    #     src="{{ downloads_dir }}/kubernetes-{{ kubernetes_version }}/bin/kubernetes/server/bin/kubectl"
    #     dest=/usr/local/bin/kubectl
    #     state=link
    #     mode=0754
    #     owner="{{ ansible_user }}"
    #   become: yes
    #   tags:
    #     - "man"

    # - name: enable kubectl completion
    #   blockinfile:
    #     dest: ~/.bashrc
    #     block: |
    #       # kubectl completion
    #       source <(kubectl completion bash)
    #   tags:
    #     - "man"
