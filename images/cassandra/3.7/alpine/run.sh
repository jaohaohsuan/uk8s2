#!/bin/bash
set -ex

CASSANDRA_RPC_ADDRESS=0.0.0.0
CASSANDRA_LISTEN_ADDRESS="${POD_IP}"
CASSANDRA_BROADCAST_ADDRESS="${POD_IP}"
CASSANDRA_BROADCAST_RPC_ADDRESS=$CASSANDRA_BROADCAST_ADDRESS

sed -ri 's/(- seeds:).*/\1 "'"$CASSANDRA_SEEDS"'"/' "$CASSANDRA_CONFIG/cassandra.yaml"

if [[ $CASSANDRA_DC && $CASSANDRA_RACK ]]; then
  CASSANDRA_ENDPOINT_SNITCH="GossipingPropertyFileSnitch"
fi

for yaml in \
  broadcast_address \
  broadcast_rpc_address \
  cluster_name \
  endpoint_snitch \
  listen_address \
  num_tokens \
  rpc_address \
  start_rpc \
; do
  var="CASSANDRA_${yaml^^}"
  val="${!var}"
  if [ "$val" ]; then
    sed -ri 's/^(# )?('"$yaml"':).*/\2 '"$val"'/' "$CASSANDRA_CONFIG/cassandra.yaml"
  fi
done


echo 'initial_token: -9208821313980305340, -9150054276573759277, -9121431625771965990, -8964356466215021411, -8958442460367342071, -8870963066091492578, -8861558190885224649, -8856522433696324107, -8745182048688554700, -8658572205530713277, -8544865929209961760, -8388843609689789095, -8213874926933779402, -7643884264338631866, -7495736063968182132, -7473372575446989332, -7426512992512696352, -7245512879295660157, -7243247490223436125, -7087772331519023733, -6986122646013730800, -6957266632028813830, -6904072750049396829, -6855055962649371342, -6694426988395407367, -6673677068672570189, -6603945560372275781, -6572440507812660761, -6501633794515212645, -6474852374126705204, -6455762218154365047, -6391616025519753033, -6372611261808482989, -6335114363250446198, -6332187424512477077, -6322679872323727921, -6286134495477738225, -6245319350409784986, -6185714945735994321, -6051014600202460367, -6013553064376482773, -6000519709470225873, -5973349381248145644, -5943709748422564108, -5938321652028784758, -5893625892230586695, -5868244280457185369, -5867165020034715542, -5864855211273485313, -5836868312354208703, -5773155896539701654, -5724968974611530925, -5619682972753473338, -5556997856421973746, -5519261663437101650, -5456826538413524867, -5292482155503117121, -5257446574069180516, -5222778063166897512, -5209193343392358839, -5045327443742071416, -5040036456454347241, -5013571394074434155, -4922741872996347120, -4886259577448207986, -4671604721934276475, -4644363711909939723, -4636931164737827108, -4600729034519985120, -4597042452713244662, -4566864870494074383, -4509387221624029219, -4424559656411093676, -4369992743376836680, -4312304938652551544, -4271033403054979695, -4250923440475482639, -4062288391821349666, -3974973831050869353, -3974529989892800678, -3964361591546460555, -3740894593202014893, -3694633424474810796, -3693386633770408742, -3545976695000661188, -3427904658521489265, -3320994963830908264, -3197424794827506058, -2963138029160760742, -2881886004196282154, -2779793638752098619, -2750135130771894797, -2679781026175049632, -2625099681503091790, -2605574177787298437, -2520806011068285366, -2511120385796493773, -2507937752003610304, -2388785545200084997, -2372868999504506063, -2260378362368134984, -2059762052618916704, -2000495649082478928, -1947647687924761458, -1738681919699115024, -1655828533911472464, -1615232906944511095, -1579055132174739170, -1525487306872489098, -1491355082038684638, -1488956108618407313, -1468725529111691766, -1368993089505428984, -1364455677206764860, -1119912817696368893, -670562455975236308, -583238475021282084, -557931010965394635, -518663319590174312, -473996354875086527, -160457486947417542, -154194844088574673, -145843779419140111, 38014141760669464, 128226078824119180, 228230332626437908, 296807342035329624, 332299741236268790, 339574144942538862, 355881059261126319, 490738676477136155, 561001292754584916, 611363130299249242, 649684598821010097, 746673640124045886, 786690578442710691, 846757896058472630, 862313686887581325, 914291292898146743, 943340831052423333, 943569653610735802, 1000495697837361331, 1004394489601720198, 1013710431873132547, 1126777656102100557, 1182584636302226254, 1228493654109755967, 1244865629274960220, 1316321129348152219, 1339790432753856808, 1378218973967842494, 1417799943303445856, 1460266651097549985, 1679337929691075042, 1732805065014018145, 1804969375379684160, 1868064596532705746, 1941367624607295298, 2017216945113670363, 2020297361850873919, 2090319449524835788, 2109707013195923541, 2133828364706276784, 2144171697708283935, 2266917450655419870, 2271357511413968654, 2285694045874597938, 2367884579033064265, 2615669986058944956, 2671317309407191164, 2720925852287835703, 2882734284559687768, 3099744809678648283, 3111706297254811177, 3145804858013007563, 3157597178832613197, 3188203349641711250, 3247784268190375624, 3254331356525003861, 3430006765375683245, 3540769689307913247, 3542362265894599173, 3650837701190578595, 3661612627061318832, 3962277456777112478, 4066047160030956502, 4204471302231941775, 4210024809974567935, 4253468780240186839, 4314229226044170116, 4396232882604017216, 4568243654763211710, 4747766694771749919, 4771652684793439746, 5022789296441327211, 5095531327887813473, 5126901003451284619, 5134837795122928838, 5206894267368640482, 5396760660001346607, 5435792009152808735, 5461271859539652791, 5469749768778184944, 5592643156335717459, 5612950224357780072, 5640777363088830941, 5684148226386566768, 5714980329184300729, 5751550816349594005, 5783615317405127399, 5804692649142549114, 5866136485358746171, 5894714566500631722, 5918585150943720510, 5942692464074183670, 5959167919627567907, 6033256906134094553, 6052371087854944685, 6182133038857083324, 6182660957301157217, 6186396721047129226, 6227198577816368860, 6250380029020263326, 6262996740484285084, 6507125504739865902, 6544900433764561604, 6550447465649913898, 6603520815821076701, 6741103803760590936, 6809881377787643391, 6843974934805394613, 6875128317620111325, 7122903145006021747, 7157079970351362035, 7456797203372867275, 7555980036354040453, 7617079697730734089, 7747821356403276764, 7762864444563843560, 7890709571214560118, 7911767524811687114, 7987386969269354433, 8179206638273348370, 8221039797001138455, 8344478405145817379, 8417921846174746029, 8420923436408734997, 8425338442129440233, 8484827841068778935, 8518549882165652328, 8544441933345360907, 8702123492584456798, 8710024352953716675, 8906155746086115008, 9043608118782029375, 9179819961468932692' >> /opt/cassandra/conf/cassandra.yaml

for rackdc in dc rack; do
  var="CASSANDRA_${rackdc^^}"
  val="${!var}"
  if [ "$val" ]; then
    sed -ri 's/^('"$rackdc"'=).*/\1 '"$val"'/' "$CASSANDRA_CONFIG/cassandra-rackdc.properties"
  fi
done

export PATH=$PATH:/opt/cassandra/bin

#ulimit -l unlimited
swapoff -a
set +ex
exec "$@"
